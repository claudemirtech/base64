<!--
Facilitador para conversão de conteúdo retornado em base64 permitindo rápida visualização e download de xml, pdf e zip
Desenvolvido por marcos.prazeres
[1.1] 2017-09-20 - Criada a função 'opcao(tipo)' e 'embutido(tipo)'; Ajustado para a visualização do pdf funcionar no navegador Chrome
[1.0] 2017-09-19 - Versão inicial
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AtomicWeb - Base64</title>
    <style>
        * {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 12px;
            text-align: center;
        }

        p {
            line-height: 30px;
        }

        a {
            cursor: pointer;
            text-decoration: none;
            color: #555;
            background-color: #ddd;
            padding: 8px;
            border-radius: 5px;
        }

        a:hover {
            background-color: #ccc;
        }

        textarea {
            border: 4px solid #ddd;
            padding: 5px;
            height: 300px;
            width: 95%;
            text-align: left;
        }

        #msg {
            color: #ff0000;
        }
    </style>
</head>
<body>
    <h2>AtomicWeb - Base64</h2>
    <p><textarea id="input" onclick="this.select()"></textarea></p>
    <p>
        <a id="limpar" onclick="limpa()">LIMPAR</a>
        <a id="converter" onclick="converte()">CONVERTER</a>
    </p>
    <p><textarea id="output" readonly="readonly"></textarea></p>
    <p><span id="msg"></span></p>
    <p>
        <span id="opcaoBaixar"></span>
        <span id="opcaoVisualizar"></span>
    </p>
    <script>
        function $(id) {

            return document.getElementById(id);

        }

        function limpa() {

            $('input').value = '';
            $('output').value = '';
            $('msg').innerHTML = '';
            $('opcaoBaixar').innerHTML = '';
            $('opcaoVisualizar').innerHTML = '';

        }

        function converte() {

            $('output').value = '';
            $('msg').innerHTML = '';
            $('opcaoBaixar').innerHTML = '';
            $('opcaoVisualizar').innerHTML = '';
            var input = $('input').value;
            if (input.trim()) {
                try {
                    var output = $('output').value = atob(input);
                    var tipo = arquivo(output.substring(0, 4));
                    opcao(tipo);
                }
                catch (erro) {
                    $('msg').innerHTML = 'ERRO: NÃO FOI POSSÍVEL REALIZAR A CONVERSÃO';
                }
            }
            else {
                $('msg').innerHTML = 'ATENÇÃO: FALTOU INFORMAR O CONTEÚDO EM BASE64 PARA REALIZAR A CONVERSÃO';
            }

        }

        function arquivo(identificador) {

            if (identificador === '%PDF') {
                return 'pdf';
            }
            if (identificador === 'PK') {
                return 'zip';
            }
            if (identificador === '<![C' || identificador === '<?xm' || identificador === '<xml') {
                return 'xml';
            }
            return 'etc';

        }

        function opcao(tipo) {

            var input = $('input').value;
            if (tipo !== 'etc') {
                var agora = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' }).split(' ').join('-');
                $('opcaoBaixar').innerHTML = '<a id="baixar" download="' + agora + '.' + tipo + '" href="data:application/' + tipo + ';base64,' + input + '">BAIXAR ' + tipo.toUpperCase() + '</a>';
                if (tipo == 'pdf') {
                    // BUGFIX: Adicionada esta alternativa devido a restrição do navegador Chrome para chamadas diretas ao 'data:'
                    if (navigator.userAgent.indexOf('Chrome') !== -1) {
                        $('opcaoVisualizar').innerHTML = '<a id="visualizar" onclick="embutido(\'' + tipo + '\')">VISUALIZAR ' + tipo.toUpperCase() + '</a>';
                    }
                    else {
                        $('opcaoVisualizar').innerHTML = '<a id="visualizar" target="_new" href="data:application/' + tipo + ';base64,' + input + '">VISUALIZAR ' + tipo.toUpperCase() + '</a>';
                    }
                }
            }

        }

        // BUGFIX: Adicionada esta alternativa devido a restrição do navegador Chrome para chamadas diretas ao 'data:'
        function embutido(tipo) {

            var input = $('input').value;
            var pagina = window.open('about:blank');
            pagina.document.write('<embed width="100%" height="100%" src="data:application/' + tipo + ';base64,' + input + '" type="application/' + tipo + '">');
            pagina.document.close();

        }
    </script>
</body>
</html>